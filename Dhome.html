<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Bus and Route - TrackMyBus.lk</title>
  <style>
    /* Reset some basic styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }

    h1 {
      color: #007bff;
      text-align: center;
      margin-bottom: 30px;
    }

    /* Navigation Bar */
    nav {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #007bff;
      padding: 10px 0;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    nav a {
      color: white;
      text-decoration: none;
      padding: 12px 20px;
      font-size: 1.1rem;
      margin: 0 15px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    nav a:hover {
      background-color: #0056b3;
    }

    /* Container for content */
    .container {
      max-width: 600px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    input,
    select,
    button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      background-color: #28a745;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }

    #addMsg,
    #errorMsg {
      font-weight: bold;
      margin-top: 10px;
    }

    #addMsg {
      color: green;
    }

    #errorMsg {
      color: red;
    }

    /* Display Bus and Route Details */
    .details {
      margin-top: 30px;
      padding: 15px;
      background-color: #e9ecef;
      border-radius: 5px;
    }

    /* Console Panel for debugging */
    .console {
      background-color: #333;
      color: #fff;
      padding: 10px;
      margin-top: 20px;
      border-radius: 5px;
      font-family: 'Courier New', Courier, monospace;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

  <!-- Navigation Bar -->
  <nav>
    <a href="Dhome.html">Home</a>
    <a href="addBusAndRoute.html">Add Bus and Route</a>
    <a href="driverTrack.html">Driver Track</a>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <h1>Add New Bus and Route</h1>
    <form id="addBusAndRouteForm">

      <!-- Bus Details -->
      <h3>Bus Details</h3>
      <div class="form-group">
        <input type="text" id="busNumber" placeholder="Bus Number" required />
      </div>
      <div class="form-group">
        <input type="text" id="plateNumber" placeholder="Plate Number" required />
      </div>
      <div class="form-group">
        <input type="number" id="capacity" placeholder="Capacity" required />
      </div>
      <div class="form-group">
        <input type="text" id="busModel" placeholder="Bus Model" required />
      </div>

      <!-- Route Details -->
      <h3>Route Details</h3>
      <div class="form-group">
        <input type="text" id="routeId" placeholder="Route ID" required />
      </div>
      <div class="form-group">
        <input type="text" id="routeName" placeholder="Route Name" required />
      </div>
      <div class="form-group">
        <input type="text" id="routeDescription" placeholder="Route Description" required />
      </div>

      <button type="submit" id="submitBtn">Add Bus and Route</button>

      <p id="addMsg"></p>
      <p id="errorMsg"></p>
    </form>

    <!-- Display Added Bus and Route -->
    <div class="details" id="details" style="display: none;">
      <h2>Bus and Route Details</h2>
      <h3>Bus Details:</h3>
      <p><strong>Bus Number:</strong> <span id="busNumberDisplay"></span></p>
      <p><strong>Plate Number:</strong> <span id="plateNumberDisplay"></span></p>
      <p><strong>Capacity:</strong> <span id="capacityDisplay"></span></p>
      <p><strong>Model:</strong> <span id="busModelDisplay"></span></p>

      <h3>Route Details:</h3>
      <p><strong>Route ID:</strong> <span id="routeIdDisplay"></span></p>
      <p><strong>Route Name:</strong> <span id="routeNameDisplay"></span></p>
      <p><strong>Route Description:</strong> <span id="routeDescriptionDisplay"></span></p>
    </div>

  </div>

  <!-- Console Panel for Debugging -->
  <div class="console">
    <h3>Console Output:</h3>
    <pre id="consoleOutput">
      Fetched User ID: <span id="fetchedUserId">Not Available</span>
    </pre>
  </div>

 <script>
  async function checkIfUserAlreadyAdded() {
    const userId = localStorage.getItem('userId');
    if (!userId) return;

    document.getElementById('fetchedUserId').textContent = userId;

    try {
      const [driverRes, busRes, routeRes] = await Promise.all([
        fetch(`/api/drivers/searchByUser?userId=${userId}`),
        fetch(`/api/buses/searchByUser?userId=${userId}`),
        fetch(`/api/routes/searchByUser?userId=${userId}`)
      ]);

      const driverData = await driverRes.json();
      const busData = await busRes.json();
      const routeData = await routeRes.json();

      if (driverData.driver || busData.bus || routeData.route) {
        document.getElementById('errorMsg').textContent =
          '❌ You have already added a bus, route, or driver!';
        document.getElementById('addBusAndRouteForm').reset();
        document.getElementById('submitBtn').disabled = true;
        document.querySelectorAll('input, select').forEach(el => el.disabled = true);
        return;
      }
    } catch (err) {
      console.error("❌ Error checking duplicates:", err);
    }
  }

  document.getElementById('addBusAndRouteForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const addMsg = document.getElementById('addMsg');
    const errorMsg = document.getElementById('errorMsg');
    addMsg.textContent = '';
    errorMsg.textContent = '';

    const busNumber = document.getElementById('busNumber').value.trim();
    const plateNumber = document.getElementById('plateNumber').value.trim();
    const capacity = document.getElementById('capacity').value.trim();
    const busModel = document.getElementById('busModel').value.trim();
    const routeId = document.getElementById('routeId').value.trim();
    const routeName = document.getElementById('routeName').value.trim();
    const routeDescription = document.getElementById('routeDescription').value.trim();

    if (!busNumber || !plateNumber || !capacity || !busModel || !routeId || !routeName || !routeDescription) {
      errorMsg.textContent = "❌ Please fill in all required fields.";
      return;
    }

    try {
      const userId = localStorage.getItem('userId');
      if (!userId) {
        errorMsg.textContent = "❌ User not logged in!";
        return;
      }

      console.log("Fetched User ID:", userId);

      const [busResCheck, routeResCheck] = await Promise.all([
        fetch(`/api/buses/search?plate_number=${plateNumber}`),
        fetch(`/api/routes/search?routeId=${routeId}`) // ✅ corrected key here
      ]);

      const busData = await busResCheck.json();
      const routeData = await routeResCheck.json();

      if (busData.length > 0) {
        errorMsg.textContent = "❌ You have already added a bus with this plate number.";
        return;
      }
      if (routeData.length > 0) {
        errorMsg.textContent = "❌ You have already added a route with this route ID.";
        return;
      }

      const newBus = {
        bus_number: busNumber,
        plate_number: plateNumber,
        capacity: Number(capacity),
        model: busModel,
        routeId, // ✅ include routeId in bus
        userId
      };

      const newRoute = {
        routeId,
        route_name: routeName,
        route_description: routeDescription,
        userId
      };

      const busRes = await fetch('/api/buses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newBus)
      });

      const routeRes = await fetch('/api/routes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newRoute)
      });

      const busResult = await busRes.json();
      const routeResult = await routeRes.json();

      if (!busRes.ok || !routeRes.ok) {
        errorMsg.textContent = "❌ " + (busResult.error || routeResult.error || "Failed to add bus or route.");
        return;
      }

      const newDriver = {
        driverId: `driver_${Date.now()}`,
        userId,
        busId: busResult.insertedId,
        routeId, // ✅ use same string routeId, not routeResult.insertedId
        status: 'on_time',
        current_location: 'unknown',
        last_update: new Date()
      };

      const driverRes = await fetch('/api/drivers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newDriver)
      });

      const driverResult = await driverRes.json();

      if (!driverRes.ok) {
        console.log("Missing data for driver:", driverResult);
        errorMsg.textContent = "❌ Failed to add driver.";
        return;
      }

      addMsg.textContent = "✅ Bus, Route, and Driver added successfully!";
      document.getElementById('addBusAndRouteForm').reset();

      document.getElementById('busNumberDisplay').textContent = busNumber;
      document.getElementById('plateNumberDisplay').textContent = plateNumber;
      document.getElementById('capacityDisplay').textContent = capacity;
      document.getElementById('busModelDisplay').textContent = busModel;
      document.getElementById('routeIdDisplay').textContent = routeId;
      document.getElementById('routeNameDisplay').textContent = routeName;
      document.getElementById('routeDescriptionDisplay').textContent = routeDescription;
      document.getElementById('details').style.display = 'block';

    } catch (err) {
      console.error(err);
      errorMsg.textContent = "❌ Network or server error. Try again.";
    }
  });

  checkIfUserAlreadyAdded();
</script>


</body>

</html>
